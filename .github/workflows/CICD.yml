name: Backend CI/CD

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  # =================================================================
  # CI Job: Runs on all PRs to dev/main and pushes to dev
  # =================================================================
  ci:
    name: Test, Lint, and Build
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: dbname
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgresql+asyncpg://user:password@localhost:5432/dbname
      REDIS_URL: redis://localhost:6379/0
      JWT_SECRET_KEY: test-secret-key-for-ci
      JWT_ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: 30
      REFRESH_TOKEN_EXPIRE_DAYS: 7

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install uv
        run: pip install uv

      - name: Install dependencies using uv
        run: uv sync

      - name: Lint & Format check with Ruff
        run: uv run ruff check . && uv run ruff format --check .

      - name: Run database migrations
        run: uv run alembic upgrade head

      - name: Run tests with Pytest
        run: uv run pytest tests/ --verbose

      - name: Build project
        run: uv build

  # =================================================================
  # CD Job: Runs only on push to dev, after CI succeeds
  # =================================================================
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: ci
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_IP }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e # Exit immediately if a command exits with a non-zero status.

            # Define the project directory
            PROJECT_DIR=~/staging-backend
            
            # Navigate to the application directory.
            # The script assumes the directory already exists from a previous clone.
            cd $PROJECT_DIR

            # Write the production .env file from GitHub secrets
            cat <<EOF > .env
            DEBUG=False
            APP_NAME="${{ vars.APP_NAME || 'LEGAL WATCH DOG' }}"
            APP_VERSION="${{ vars.APP_VERSION || '1.0.0' }}"
            APP_PORT="${{ secrets.APP_PORT || vars.APP_PORT || '8000' }}"
            ENVIRONMENT="${{ vars.ENVIRONMENT || 'production' }}"
            SECRET_KEY="${{ secrets.SECRET_KEY }}"
            LEGAL_WATCH_DOG_BASE_URL="${{ secrets.LEGAL_WATCH_DOG_BASE_URL }}"

            DB_TYPE="postgresql"
            DB_HOST="${{ secrets.DB_HOST }}"
            DB_PORT="${{ vars.DB_PORT || '5432' }}"
            DB_USER="${{ secrets.DB_USER }}"
            DB_PASS="${{ secrets.DB_PASS }}"
            DB_NAME="${{ secrets.DB_NAME }}"
            DATABASE_URL="postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASS }}@${{ secrets.DB_HOST }}/${{ secrets.DB_NAME }}"

            MAIL_MAILER="smtp"
            SMTP_SERVER="${{ vars.SMTP_SERVER || 'smtp.gmail.com' }}"
            SMTP_PORT="${{ vars.SMTP_PORT || '587' }}"
            MAIL_USERNAME="${{ secrets.MAIL_USERNAME }}"
            MAIL_PASSWORD="${{ secrets.MAIL_PASSWORD }}"
            MAIL_ENCRYPTION="TLS"
            EMAIL="${{ secrets.EMAIL }}"
            MAIL_FROM_NAME="LEGAL WATCH DOG"
            EOF

            # Pull the latest changes from the main branch
            git pull origin main

            # Install/update dependencies using uv
            curl -LsSf https://astral.sh/uv/install.sh | sh
            export PATH="$HOME/.cargo/bin:$PATH"
            uv sync

            # Apply any new database migrations
            uv run alembic upgrade head

            # Create the systemd service file for the application
            cat << EOF | sudo tee /etc/systemd/system/legal-watch-dog.service
            [Unit]
            Description=Legal Watch Dog FastAPI Application
            After=network.target

            [Service]
            User=ubuntu
            Group=ubuntu
            WorkingDirectory=$PROJECT_DIR
            EnvironmentFile=$PROJECT_DIR/.env
            ExecStart=$PROJECT_DIR/.venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000
            Restart=always
            RestartSec=5s

            [Install]
            WantedBy=multi-user.target
            EOF

            # Reload systemd to recognize the new service, enable it, and restart it
            sudo systemctl daemon-reload
            sudo systemctl enable legal-watch-dog.service
            sudo systemctl restart legal-watch-dog.service

            echo "Deployment to dev environment completed successfully!"